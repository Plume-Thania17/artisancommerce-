{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    /* ==================== CHECKOUT PAGE ==================== */
    .checkout-section {
        padding: 3rem 0;
        background: var(--light-gray);
        min-height: calc(100vh - 200px);
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray);
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }
    
    .back-link:hover {
        color: var(--primary-blue);
    }
    
    /* ==================== PROGRESS STEPS ==================== */
    .checkout-progress {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .step-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--white);
        border: 2px solid var(--light-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--gray);
        transition: all 0.3s ease;
    }
    
    .step-circle.completed {
        background: var(--salmon);
        border-color: var(--salmon);
        color: var(--white);
    }
    
    .step-circle.active {
        background: var(--salmon);
        border-color: var(--salmon);
        color: var(--white);
    }
    
    .step-label {
        font-weight: 600;
        color: var(--gray);
    }
    
    .step-label.completed,
    .step-label.active {
        color: var(--salmon);
    }
    
    /* ==================== LAYOUT ==================== */
    .checkout-container {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 2rem;
        align-items: start;
    }
    
    /* ==================== LEFT SIDE - FORMS ==================== */
    .checkout-forms {
        background: var(--white);
        border-radius: 15px;
        padding: 2.5rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
        animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .section-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--black);
        margin-bottom: 1rem;
    }
    
    .section-subtitle {
        color: var(--gray);
        margin-bottom: 2rem;
    }
    
    /* ==================== ADDRESS CARDS ==================== */
    .address-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .address-card {
        padding: 1.5rem;
        border: 2px solid var(--light-gray);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .address-card:hover {
        border-color: var(--primary-blue);
    }
    
    .address-card.selected {
        border-color: var(--salmon);
        background: rgba(255, 139, 123, 0.05);
    }
    
    .address-card.selected::before {
        content: '‚úì';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: var(--salmon);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
    }
    
    .address-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .address-icon {
        width: 32px;
        height: 32px;
        background: var(--light-gray);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    
    .address-type {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--black);
    }
    
    .address-badge {
        padding: 0.25rem 0.75rem;
        background: var(--salmon);
        color: var(--white);
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: auto;
    }
    
    .address-details {
        color: var(--gray);
        line-height: 1.6;
        padding-left: 2.5rem;
    }
    
    .address-name {
        font-weight: 600;
        color: var(--black);
    }
    
    .add-address-btn {
        width: 100%;
        padding: 1.25rem;
        border: 2px dashed var(--light-gray);
        background: transparent;
        border-radius: 12px;
        color: var(--gray);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .add-address-btn:hover {
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        background: var(--light-blue);
    }
    
    /* ==================== PAYMENT METHODS ==================== */
    .payment-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .payment-card {
        padding: 1.5rem;
        border: 2px solid var(--light-gray);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        position: relative;
    }
    
    .payment-card:hover {
        border-color: var(--primary-blue);
    }
    
    .payment-card.selected {
        border-color: var(--salmon);
        background: rgba(255, 139, 123, 0.05);
    }
    
    .payment-card.selected::before {
        content: '‚úì';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: var(--salmon);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
    }
    
    .payment-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .payment-icon.orange {
        background: #FF7900;
        color: var(--white);
    }
    
    .payment-icon.wave {
        background: #1D5ECD;
        color: var(--white);
    }
    
    .payment-icon.cash {
        background: #28A745;
        color: var(--white);
    }
    
    .payment-info h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--black);
        margin-bottom: 0.25rem;
    }
    
    .payment-info p {
        font-size: 14px;
        color: var(--gray);
    }
    
    .payment-notice {
        background: #E3F2FD;
        border-left: 4px solid #2196F3;
        padding: 1.25rem;
        border-radius: 8px;
        margin-top: 1.5rem;
    }
    
    .payment-notice p {
        color: var(--dark-gray);
        margin: 0;
        line-height: 1.6;
    }
    
    /* ==================== FORM ACTIONS ==================== */
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn {
        flex: 1;
        padding: 1.125rem;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-align: center;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: var(--salmon);
        color: var(--white);
    }
    
    .btn-primary:hover {
        background: var(--dark-salmon);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 139, 123, 0.3);
    }
    
    .btn-secondary {
        background: var(--white);
        color: var(--dark-gray);
        border: 2px solid var(--light-gray);
    }
    
    .btn-secondary:hover {
        border-color: var(--gray);
    }
    
    /* ==================== ORDER SUMMARY ==================== */
    .order-summary {
        background: var(--white);
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 100px;
    }
    
    .summary-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--black);
        margin-bottom: 2rem;
    }
    
    .order-item {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--light-gray);
    }
    
    .item-image {
        width: 70px;
        height: 70px;
        border-radius: 10px;
        object-fit: cover;
        background: var(--light-gray);
        position: relative;
    }
    
    .item-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: var(--salmon);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        border: 2px solid var(--white);
    }
    
    .item-details {
        flex: 1;
    }
    
    .item-name {
        font-weight: 700;
        color: var(--black);
        margin-bottom: 0.25rem;
    }
    
    .item-category {
        font-size: 14px;
        color: var(--gray);
    }
    
    .item-price {
        font-weight: 700;
        color: var(--black);
        text-align: right;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
    }
    
    .summary-label {
        color: var(--gray);
        font-weight: 500;
    }
    
    .summary-value {
        color: var(--black);
        font-weight: 600;
    }
    
    .summary-value.free {
        color: #28A745;
        font-weight: 700;
    }
    
    .summary-row.total {
        padding: 1.25rem 0;
        margin-top: 1rem;
        border-top: 2px solid var(--light-gray);
    }
    
    .summary-row.total .summary-label {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--black);
    }
    
    .summary-row.total .summary-value {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--salmon);
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1024px) {
        .checkout-container {
            grid-template-columns: 1fr;
        }
        
        .order-summary {
            position: static;
        }
    }
    
    @media (max-width: 768px) {
        .checkout-progress {
            gap: 1rem;
        }
        
        .step-label {
            display: none;
        }
        
        .form-actions {
            flex-direction: column-reverse;
        }
    }
</style>

<section class="checkout-section">
    <div class="container">
        <!-- Back Link -->
        <a href="{% url 'checkout' %}" class="back-link">
            ‚Üê Retour au panier
        </a>
        
        <!-- Progress Steps -->
        <div class="checkout-progress">
            <div class="progress-step" id="progress-1">
                <div class="step-circle completed">‚úì</div>
                <span class="step-label completed">Connexion</span>
            </div>
            <div class="progress-step" id="progress-2">
                <div class="step-circle active">2</div>
                <span class="step-label active">Adresse</span>
            </div>
            <div class="progress-step" id="progress-3">
                <div class="step-circle">3</div>
                <span class="step-label">Paiement</span>
            </div>
        </div>
        
        <!-- Checkout Container -->
        <div class="checkout-container">
            <!-- Left Side - Forms -->
            <div class="checkout-forms">
                <!-- Step 2: Address -->
                <div class="form-section active" id="step-address">
                    <h2 class="section-title">Adresse de livraison</h2>
                    <p class="section-subtitle">Selectionnez une adresse ou ajoutez-en une nouvelle.</p>
                    
                    <div class="address-list">
                        <!-- Address Card 1 -->
                        <div class="address-card selected" data-address="1">
                            <div class="address-header">
                                <div class="address-icon">üìç</div>
                                <span class="address-type">Domicile</span>
                                <span class="address-badge">Par d√©faut</span>
                            </div>
                            <div class="address-details">
                                <div class="address-name">{{ user.get_full_name|default:"Aminata Kon√©" }}</div>
                                <div>Rue des Jardins, Cocody</div>
                                <div>Abidjan</div>
                                <div>+225 07 08 09 10 11</div>
                            </div>
                        </div>
                        
                        <!-- Address Card 2 -->
                        <div class="address-card" data-address="2">
                            <div class="address-header">
                                <div class="address-icon">üìç</div>
                                <span class="address-type">Bureau</span>
                            </div>
                            <div class="address-details">
                                <div class="address-name">{{ user.get_full_name|default:"Aminata Kon√©" }}</div>
                                <div>Avenue Chardy, Plateau</div>
                                <div>Abidjan</div>
                                <div>+225 07 08 09 10 12</div>
                            </div>
                        </div>
                        
                        <!-- Add Address Button -->
                        <button class="add-address-btn">
                            ‚ûï Ajouter une nouvelle adresse
                        </button>
                    </div>
                    
                    <div class="form-actions">
                        <a href="{% url 'checkout' %}" class="btn btn-secondary">Retour</a>
                        <button class="btn btn-primary" onclick="goToStep(3)">Continuer vers le paiement</button>
                    </div>
                </div>
                
                <!-- Step 3: Payment -->
                <div class="form-section" id="step-payment">
                    <h2 class="section-title">Mode de paiement</h2>
                    <p class="section-subtitle">Choisissez votre methode de paiement preferee.</p>
                    
                    <!-- Delivery Address Summary -->
                    <div style="background: var(--light-gray); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--dark-gray);">üìç Livraison a</span>
                            <a href="#" onclick="goToStep(2); return false;" style="margin-left: auto; color: var(--salmon); font-size: 14px; font-weight: 600; text-decoration: none;">Modifier</a>
                        </div>
                        <div style="font-size: 14px; color: var(--gray); line-height: 1.5;" id="selected-address-display">
                            <div style="font-weight: 600; color: var(--black);">{{ user.get_full_name|default:"Aminata Kon√©" }}</div>
                            <div>Rue des Jardins, Cocody</div>
                            <div>Abidjan</div>
                        </div>
                    </div>
                    
                    <div class="payment-list">
                        <!-- Orange Money -->
                        <div class="payment-card selected" data-payment="orange">
                            <div class="payment-icon orange">üì±</div>
                            <div class="payment-info">
                                <h3>Orange Money</h3>
                                <p>Paiement mobile s√©curis√©</p>
                            </div>
                        </div>
                        
                        <!-- Wave -->
                        <div class="payment-card" data-payment="wave">
                            <div class="payment-icon wave">üì±</div>
                            <div class="payment-info">
                                <h3>Wave</h3>
                                <p>Transfert mobile rapide</p>
                            </div>
                        </div>
                        
                        <!-- Cash on Delivery -->
                        <div class="payment-card" data-payment="cash">
                            <div class="payment-icon cash">üì¶</div>
                            <div class="payment-info">
                                <h3>Paiement a la livraison</h3>
                                <p>Payez en especes a la reception</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-notice">
                        <p>Vous allez recevoir une notification sur votre telephone pour confirmer le paiement de <strong id="payment-total">85 000 F CFA</strong></p>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="goToStep(2)">Retour</button>
                        <button class="btn btn-primary" onclick="confirmOrder()">Confirmer la commande</button>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Order Summary -->
            <div class="order-summary">
                <h2 class="summary-title">Votre commande</h2>
                
                <div id="order-items">
                    <!-- Items will be loaded dynamically -->
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Sous-total</span>
                    <span class="summary-value" id="subtotal">85 000 F CFA</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Livraison</span>
                    <span class="summary-value free">Gratuite</span>
                </div>
                
                <div class="summary-row total">
                    <span class="summary-label">Total</span>
                    <span class="summary-value" id="total">85 000 F CFA</span>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Load cart items
document.addEventListener('DOMContentLoaded', function() {
    loadOrderSummary();
});

function loadOrderSummary() {
    const Panier = JSON.parse(localStorage.getItem('Panier')) || {};
    const orderItems = document.getElementById('order-items');
    
    if (Object.keys(Panier).length === 0) {
        window.location.href = "{% url 'checkout' %}";
        return;
    }
    
    let html = '';
    let subtotal = 0;
    
    for (const [id, details] of Object.entries(Panier)) {
        const quantity = parseInt(details[0]) || 1;
        const total = parseFloat(details[2]) || 0;
        const name = details[1] || 'Produit';
        subtotal += total;
        
        html += `
            <div class="order-item">
                <div style="position: relative;">
                    <img src="https://via.placeholder.com/70" alt="${name}" class="item-image">
                    <div class="item-badge">${quantity}</div>
                </div>
                <div class="item-details">
                    <div class="item-name">${name}</div>
                    <div class="item-category">Artisanat</div>
                </div>
                <div class="item-price">${total.toLocaleString()} F CFA</div>
            </div>
        `;
    }
    
    orderItems.innerHTML = html;
    document.getElementById('subtotal').textContent = subtotal.toLocaleString() + ' F CFA';
    document.getElementById('total').textContent = subtotal.toLocaleString() + ' F CFA';
    document.getElementById('payment-total').textContent = subtotal.toLocaleString() + ' F CFA';
}

// Address selection
document.querySelectorAll('.address-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
    });
});

// Payment selection
document.querySelectorAll('.payment-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
    });
});

// Navigation between steps
function goToStep(step) {
    // Hide all sections
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    
    // Show selected section
    if (step === 2) {
        document.getElementById('step-address').classList.add('active');
        updateProgress(2);
    } else if (step === 3) {
        document.getElementById('step-payment').classList.add('active');
        updateProgress(3);
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgress(activeStep) {
    for (let i = 1; i <= 3; i++) {
        const progress = document.getElementById('progress-' + i);
        const circle = progress.querySelector('.step-circle');
        const label = progress.querySelector('.step-label');
        
        if (i < activeStep) {
            circle.classList.add('completed');
            circle.classList.remove('active');
            circle.innerHTML = '‚úì';
            label.classList.add('completed');
            label.classList.remove('active');
        } else if (i === activeStep) {
            circle.classList.add('active');
            circle.classList.remove('completed');
            circle.innerHTML = i;
            label.classList.add('active');
            label.classList.remove('completed');
        } else {
            circle.classList.remove('completed', 'active');
            circle.innerHTML = i;
            label.classList.remove('completed', 'active');
        }
    }
}

// Fonction pour r√©cup√©rer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Confirm order
function confirmOrder() {
    const selectedPayment = document.querySelector('.payment-card.selected');
    const selectedAddress = document.querySelector('.address-card.selected');
    
    if (!selectedPayment) {
        alert('Veuillez s√©lectionner un mode de paiement');
        return;
    }
    
    if (!selectedAddress) {
        alert('Veuillez s√©lectionner une adresse de livraison');
        return;
    }
    
    // R√©cup√©rer les donn√©es du panier
    const Panier = JSON.parse(localStorage.getItem('Panier')) || {};
    const paymentMethod = selectedPayment.dataset.payment;
    
    // R√©cup√©rer les d√©tails de l'adresse s√©lectionn√©e
    const addressDetails = selectedAddress.querySelector('.address-details');
    const addressDivs = addressDetails.querySelectorAll('div');
    const addressName = addressDivs[0].textContent;
    const addressLine = addressDivs[1].textContent;
    const ville = addressDivs[2].textContent;
    const phone = addressDivs[3].textContent;
    
    // Pr√©parer les items
    const items = [];
    let subtotal = 0;
    
    for (const [id, details] of Object.entries(Panier)) {
        const quantity = parseInt(details[0]) || 1;
        const total = parseFloat(details[2]) || 0;
        const unitPrice = total / quantity;
        
        items.push({
            product_id: id,
            name: details[1],
            quantity: quantity,
            price: unitPrice,
            total: total
        });
        
        subtotal += total;
    }
    
    // Afficher un message de chargement
    const confirmBtn = event.target;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Traitement en cours...';
    
    // Envoyer au serveur Django
    fetch("{% url 'process_order' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            items: items,
            total: subtotal,
            payment_method: paymentMethod,
            address: addressLine,
            ville: ville,
            phone: phone,
            name: addressName,
            pays: 'C√¥te d\'Ivoire'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Vider le panier
            localStorage.removeItem('Panier');
            updateCartCount();
            
            // Rediriger vers la page de succ√®s
            window.location.href = data.redirect_url;
        } else {
            alert('Erreur : ' + (data.message || 'Une erreur est survenue'));
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirmer la commande';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la commande');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirmer la commande';
    });
}

// Mettre √† jour le compteur du panier
function updateCartCount() {
    const Panier = JSON.parse(localStorage.getItem('Panier')) || {};
    let count = 0;
    for (const item_id in Panier) {
        count += parseInt(Panier[item_id][0]);
    }
    const cartCountEl = document.getElementById('cart-count');
    if (cartCountEl) {
        cartCountEl.textContent = count;
    }
}
</script>
{% endblock %}